<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Главная</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Стили для верхней панели */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #333;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .user-info {
            font-size: 18px;
        }
        .auth-buttons button {
            margin-left: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
        /* Стили для popup */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
        }
        .popup input {
            display: block;
            margin: 10px 0;
            width: 100%;
            padding: 8px;
        }
        .popup button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .popup-close {
            text-align: right;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Верхняя панель -->
    <div class="top-bar">
        <div class="user-info">Гость</div>
        <div class="auth-buttons">
            <button onclick="showPopup('login-popup')">Войти</button>
            <button onclick="showPopup('register-popup')">Регистрация</button>
            <button onclick="logout()" style="display: none;">Выйти</button>
            <button onclick="showPopup('change-password-popup')" style="display: none;">Сменить пароль</button>
        </div>
    </div>

    <!-- Popup для входа -->
    <div id="login-popup" class="popup">
        <div class="popup-close" onclick="closePopup('login-popup')">✖</div>
        <h3>Вход</h3>
        <input type="text" id="login-username" placeholder="Имя пользователя">
        <input type="password" id="login-password" placeholder="Пароль">
        <button onclick="login()">Войти</button>
    </div>

    <!-- Popup для регистрации -->
    <div id="register-popup" class="popup">
        <div class="popup-close" onclick="closePopup('register-popup')">✖</div>
        <h3>Регистрация</h3>
        <input type="text" id="register-username" placeholder="Имя пользователя">
        <input type="password" id="register-password" placeholder="Пароль">
        <input type="password" id="register-password-confirm" placeholder="Повторите пароль">
        <button onclick="register()">Зарегистрироваться</button>
    </div>

    <!-- Popup для смены пароля -->
    <div id="change-password-popup" class="popup">
        <div class="popup-close" onclick="closePopup('change-password-popup')">✖</div>
        <h3>Смена пароля</h3>
        <input type="password" id="old-password" placeholder="Старый пароль">
        <input type="password" id="new-password" placeholder="Новый пароль">
        <button onclick="changePassword()">Сменить</button>
    </div>

    <script>
        const SECRET_KEY = "my_secret_key"; // Ключ для шифрования

        function encrypt(text) {
            return CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
        }

        function decrypt(text) {
            try {
                return CryptoJS.AES.decrypt(text, SECRET_KEY).toString(CryptoJS.enc.Utf8);
            } catch {
                return null;
            }
        }

        function showPopup(id) {
            document.getElementById(id).style.display = "block";
        }

        function closePopup(id) {
            document.getElementById(id).style.display = "none";
        }

        function register() {
            let username = document.getElementById("register-username").value;
            let password = document.getElementById("register-password").value;
            let confirmPassword = document.getElementById("register-password-confirm").value;

            if (password !== confirmPassword) {
                alert("Пароли не совпадают!");
                return;
            }

            let users = JSON.parse(localStorage.getItem("users") || "{}");
            if (users[username]) {
                alert("Пользователь уже существует!");
                return;
            }

            users[username] = encrypt(password);
            localStorage.setItem("users", JSON.stringify(users));

            alert("Регистрация успешна!");
            closePopup("register-popup");
        }

        function login() {
            let username = document.getElementById("login-username").value;
            let password = document.getElementById("login-password").value;

            let users = JSON.parse(localStorage.getItem("users") || "{}");
            if (!users[username] || decrypt(users[username]) !== password) {
                alert("Неверное имя пользователя или пароль!");
                return;
            }

            localStorage.setItem("loggedUser", username);
            updateUI();
            closePopup("login-popup");
        }

        function logout() {
            localStorage.removeItem("loggedUser");
            updateUI();
        }

        function changePassword() {
            let oldPassword = document.getElementById("old-password").value;
            let newPassword = document.getElementById("new-password").value;

            let username = localStorage.getItem("loggedUser");
            if (!username) return alert("Вы не авторизованы!");

            let users = JSON.parse(localStorage.getItem("users") || "{}");
            if (decrypt(users[username]) !== oldPassword) {
                alert("Старый пароль неверен!");
                return;
            }

            users[username] = encrypt(newPassword);
            localStorage.setItem("users", JSON.stringify(users));

            alert("Пароль успешно изменен!");
            closePopup("change-password-popup");
        }

        function updateUI() {
            let username = localStorage.getItem("loggedUser");
            let userInfo = document.querySelector(".user-info");
            let loginBtn = document.querySelector(".auth-buttons button:nth-child(1)");
            let registerBtn = document.querySelector(".auth-buttons button:nth-child(2)");
            let logoutBtn = document.querySelector(".auth-buttons button:nth-child(3)");
            let changePasswordBtn = document.querySelector(".auth-buttons button:nth-child(4)");

            if (username) {
                userInfo.textContent = `Вы вошли как ${username}`;
                loginBtn.style.display = "none";
                registerBtn.style.display = "none";
                logoutBtn.style.display = "inline-block";
                changePasswordBtn.style.display = "inline-block";
            } else {
                userInfo.textContent = "Гость";
                loginBtn.style.display = "inline-block";
                registerBtn.style.display = "inline-block";
                logoutBtn.style.display = "none";
                changePasswordBtn.style.display = "none";
            }
        }

        updateUI();
    </script>

</body>
</html>
